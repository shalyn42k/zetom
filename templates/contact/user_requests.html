{% load static %}
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if lang == 'pl' %}Moje zgłoszenia – ZETOM Katowice{% else %}My requests – ZETOM Katowice{% endif %}</title>
    <link rel="shortcut icon" href="{% static 'img/zet1.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'css/public.css' %}">
</head>
<body class="user-requests-page{% if active_message_id %} has-open-modal{% endif %}">
<header class="site-header">
    <a href="{% url 'contact:login' %}?lang={{ lang }}" class="site-branding" title="{% if lang == 'pl' %}Panel administratora{% else %}Admin panel{% endif %}" aria-label="{% if lang == 'pl' %}Panel administratora{% else %}Admin panel{% endif %}">
        <img src="{% static 'img/zet3.avif' %}" alt="ZETOM Katowice" class="site-logo">
        <div>
            <h1 class="site-title">ZETOM Katowice</h1>
            <p class="site-subtitle">{% if lang == 'pl' %}Badania • Certyfikacja • Kontrola techniczna{% else %}Testing • Certification • Technical inspections{% endif %}</p>
        </div>
    </a>
    <nav class="site-nav">
        <a href="{% url 'contact:index' %}?lang={{ lang }}">{% if lang == 'pl' %}Strona główna{% else %}Home{% endif %}</a>
        <a href="{% url 'contact:user_requests' %}?lang={{ lang }}" class="is-active">{% if lang == 'pl' %}Moje zgłoszenia{% else %}My requests{% endif %}</a>
    </nav>
    <div class="site-header__actions">
        <div class="lang-switcher">
            <a href="{% url 'contact:user_requests' %}?lang=pl" class="{% if lang == 'pl' %}is-active{% endif %}">PL</a>
            <a href="{% url 'contact:user_requests' %}?lang=en" class="{% if lang != 'pl' %}is-active{% endif %}">EN</a>
        </div>
    </div>
</header>

<main class="user-requests">
    <section class="requests-section">
        <div class="requests-heading">
            <h2 class="requests-title">{% if lang == 'pl' %}Twoje zgłoszenia{% else %}Your requests{% endif %}</h2>
            <p class="requests-subtitle">{{ update_hint }}</p>
        </div>

        {% if messages %}
            <div class="message-list">
                {% for msg in messages %}
                    {% with tags=msg.tags %}
                        <div class="alert {% if 'success' in tags %}alert-success{% elif 'error' in tags or 'warning' in tags %}alert-error{% else %}alert-success{% endif %}">
                            {{ msg }}
                        </div>
                    {% endwith %}
                {% endfor %}
            </div>
        {% endif %}

        {% if has_messages %}
            <div class="requests-carousel" data-requests-carousel>
                <button type="button" class="requests-carousel__control" data-carousel-nav="prev" aria-label="{% if lang == 'pl' %}Poprzednie zgłoszenie{% else %}Previous request{% endif %}">
                    <span aria-hidden="true">‹</span>
                </button>
                <div class="requests-carousel__viewport">
                    <div class="requests-carousel__track" data-carousel-track>
                        {% for entry in entries %}
                            <article class="request-tile {{ entry.status_badge }}{% if entry.is_active %} is-active{% endif %}" data-request-tile data-message-id="{{ entry.message.id }}" tabindex="0">
                                <div class="request-tile__status" aria-hidden="true"></div>
                                <div class="request-tile__body">
                                    <h3 class="request-tile__title">{% if lang == 'pl' %}Zgłoszenie{% else %}Request{% endif %} #{{ entry.message.id }}</h3>
                                    <p class="request-tile__meta">{{ entry.message.created_at|date:'Y-m-d H:i' }} · {{ entry.company_label }}</p>
                                    <span class="status-chip">{{ entry.status_label }}</span>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" class="requests-carousel__control" data-carousel-nav="next" aria-label="{% if lang == 'pl' %}Następne zgłoszenie{% else %}Next request{% endif %}">
                    <span aria-hidden="true">›</span>
                </button>
            </div>

            <div class="requests-overlay{% if active_message_id %} is-visible{% endif %}" data-requests-overlay>
                {% for entry in entries %}
                    <section class="request-modal{% if entry.is_active %} is-active{% endif %}" data-request-modal="{{ entry.message.id }}" aria-hidden="{% if entry.is_active %}false{% else %}true{% endif %}">
                        <div class="request-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="request-modal-title-{{ entry.message.id }}">
                            <button type="button" class="request-modal__close" data-modal-close aria-label="{% if lang == 'pl' %}Zamknij{% else %}Close{% endif %}">×</button>
                            <header class="request-modal__header">
                                <div>
                                    <p class="request-modal__label">{% if lang == 'pl' %}Zgłoszenie{% else %}Request{% endif %} #{{ entry.message.id }}</p>
                                    <h3 class="request-modal__title" id="request-modal-title-{{ entry.message.id }}">{{ entry.company_label }}</h3>
                                    <p class="request-modal__meta">{{ entry.message.created_at|date:'Y-m-d H:i' }}</p>
                                </div>
                                <span class="status-chip {{ entry.status_badge }}">{{ entry.status_label }}</span>
                            </header>
                            <form method="post" action="{% url 'contact:user_requests' %}?lang={{ lang }}" class="request-modal__form">
                                {% csrf_token %}
                                <input type="hidden" name="message_id" value="{{ entry.message.id }}">
                                <input type="hidden" name="form_prefix" value="{{ entry.form.prefix }}">
                                {% if entry.form.non_field_errors %}
                                    <div class="form-error">{{ entry.form.non_field_errors.0 }}</div>
                                {% endif %}
                                <div class="request-modal__grid">
                                    <label class="form-field">
                                        <span class="form-label">{% if lang == 'pl' %}Imię{% else %}First name{% endif %}</span>
                                        {{ entry.form.first_name }}
                                        {% if entry.form.first_name.errors %}<span class="form-error">{{ entry.form.first_name.errors.0 }}</span>{% endif %}
                                    </label>
                                    <label class="form-field">
                                        <span class="form-label">{% if lang == 'pl' %}Nazwisko{% else %}Last name{% endif %}</span>
                                        {{ entry.form.last_name }}
                                        {% if entry.form.last_name.errors %}<span class="form-error">{{ entry.form.last_name.errors.0 }}</span>{% endif %}
                                    </label>
                                    <label class="form-field">
                                        <span class="form-label">{% if lang == 'pl' %}Telefon{% else %}Phone{% endif %}</span>
                                        {{ entry.form.phone }}
                                        {% if entry.form.phone.errors %}<span class="form-error">{{ entry.form.phone.errors.0 }}</span>{% endif %}
                                    </label>
                                    <label class="form-field">
                                        <span class="form-label">E-mail</span>
                                        {{ entry.form.email }}
                                        {% if entry.form.email.errors %}<span class="form-error">{{ entry.form.email.errors.0 }}</span>{% endif %}
                                    </label>
                                    <label class="form-field">
                                        <span class="form-label">{% if lang == 'pl' %}Firma{% else %}Company{% endif %}</span>
                                        {{ entry.form.company }}
                                        {% if entry.form.company.errors %}<span class="form-error">{{ entry.form.company.errors.0 }}</span>{% endif %}
                                    </label>
                                    <label class="form-field form-field--wide">
                                        <span class="form-label">{% if lang == 'pl' %}Treść zgłoszenia{% else %}Request details{% endif %}</span>
                                        {{ entry.form.message }}
                                        {% if entry.form.message.errors %}<span class="form-error">{{ entry.form.message.errors.0 }}</span>{% endif %}
                                    </label>
                                </div>
                                <div class="request-modal__actions">
                                    <button type="submit" name="action" value="update" class="button button--primary">{% if lang == 'pl' %}Zapisz zmiany{% else %}Save changes{% endif %}</button>
                                    <button type="submit" name="action" value="delete" class="button button--danger" data-delete-button data-confirm="{% if lang == 'pl' %}Czy na pewno chcesz usunąć to zgłoszenie?{% else %}Are you sure you want to delete this request?{% endif %}">{% if lang == 'pl' %}Usuń zgłoszenie{% else %}Delete request{% endif %}</button>
                                </div>
                            </form>
                        </div>
                    </section>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h3 class="empty-state__title">{{ empty_state_title }}</h3>
                <p class="empty-state__text">{{ empty_state_text }}</p>
                <a href="{% url 'contact:index' %}?lang={{ lang }}" class="button button--primary empty-state__action">
                    {% if lang == 'pl' %}Przejdź do formularza{% else %}Go to the form{% endif %}
                </a>
            </div>
        {% endif %}
    </section>
</main>

<footer class="site-footer">
    <p>© {% now 'Y' %} ZETOM Katowice</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const carousel = document.querySelector('[data-requests-carousel]');
        const track = carousel ? carousel.querySelector('[data-carousel-track]') : null;
        const tiles = carousel ? Array.from(carousel.querySelectorAll('[data-request-tile]')) : [];
        const overlay = document.querySelector('[data-requests-overlay]');
        const modals = new Map();

        document.querySelectorAll('[data-request-modal]').forEach(function (modal) {
            modals.set(modal.getAttribute('data-request-modal'), modal);
        });

        const closeAllModals = function () {
            modals.forEach(function (modal) {
                modal.classList.remove('is-active');
                modal.setAttribute('aria-hidden', 'true');
            });
            tiles.forEach(function (tile) {
                tile.classList.remove('is-active');
            });
            if (overlay) {
                overlay.classList.remove('is-visible');
            }
            document.body.classList.remove('has-open-modal');
        };

        const openModal = function (id) {
            const modal = modals.get(String(id));
            if (!modal) {
                return;
            }
            modals.forEach(function (panel) {
                const isActive = panel === modal;
                panel.classList.toggle('is-active', isActive);
                panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
            });
            tiles.forEach(function (tile) {
                tile.classList.toggle('is-active', tile.getAttribute('data-message-id') === String(id));
            });
            if (overlay) {
                overlay.classList.add('is-visible');
            }
            document.body.classList.add('has-open-modal');
            const focusable = modal.querySelector('input, textarea, select, button');
            if (focusable) {
                focusable.focus({ preventScroll: true });
            }
        };

        if (overlay) {
            overlay.addEventListener('click', function (event) {
                if (event.target === overlay) {
                    closeAllModals();
                }
            });
        }

        document.querySelectorAll('[data-modal-close]').forEach(function (button) {
            button.addEventListener('click', function () {
                closeAllModals();
            });
        });

        tiles.forEach(function (tile) {
            tile.addEventListener('click', function () {
                const id = tile.getAttribute('data-message-id');
                openModal(id);
            });
            tile.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    openModal(tile.getAttribute('data-message-id'));
                }
            });
        });

        document.querySelectorAll('[data-carousel-nav]').forEach(function (button) {
            if (!track) {
                return;
            }
            const direction = button.getAttribute('data-carousel-nav');
            button.addEventListener('click', function () {
                const width = track.clientWidth;
                const offset = width * 0.8 * (direction === 'prev' ? -1 : 1);
                track.scrollBy({ left: offset, behavior: 'smooth' });
            });
        });

        document.querySelectorAll('[data-delete-button]').forEach(function (button) {
            button.addEventListener('click', function (event) {
                const message = button.getAttribute('data-confirm');
                if (message && !window.confirm(message)) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        });

        const initialModal = document.querySelector('.request-modal.is-active');
        if (initialModal) {
            if (overlay) {
                overlay.classList.add('is-visible');
            }
            document.body.classList.add('has-open-modal');
            const activeId = initialModal.getAttribute('data-request-modal');
            tiles.forEach(function (tile) {
                tile.classList.toggle('is-active', tile.getAttribute('data-message-id') === activeId);
            });
            const focusable = initialModal.querySelector('input, textarea, select, button');
            if (focusable) {
                focusable.focus({ preventScroll: true });
            }
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeAllModals();
            }
        });
    });
</script>
</body>
</html>
