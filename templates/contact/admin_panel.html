{% load static %}
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if lang == 'pl' %}Panel administracyjny{% else %}Admin panel{% endif %}</title>
    <link rel="shortcut icon" href="{% static 'img/zet1.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <script src="{% static 'js/admin.js' %}" defer></script>
</head>
<body{% if trash_form.errors or download_form.errors %} class="has-modal"{% endif %}>
<div class="overlay"></div>
<div class="modal{% if trash_form.errors %} is-visible{% endif %}" data-trash-modal aria-hidden="{% if trash_form.errors %}false{% else %}true{% endif %}">
    <div class="modal__backdrop" data-trash-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="trash-title">
        <button type="button" class="modal__close" data-trash-close aria-label="{% if lang == 'pl' %}Zamknij kosz{% else %}Close trash{% endif %}">×</button>
        <h2 class="modal__title" id="trash-title">{% if lang == 'pl' %}Kosz{% else %}Trash{% endif %}</h2>
        <form method="post" class="modal__form" data-trash-form>
            {% csrf_token %}
            {{ trash_form.form_name }}
            <input type="hidden" name="page" value="{{ current_page }}">
            <input type="hidden" name="sort_by" value="{{ current_sort }}">
            <input type="hidden" name="company" value="{{ current_company }}">
            {{ trash_form.action }}
            <div class="modal__toolbar">
                <label class="checkbox-pill">
                    <input type="checkbox" data-trash-select-all {% if not deleted_messages %}disabled{% endif %}>
                    <span>{% if lang == 'pl' %}Zaznacz wszystkie{% else %}Select all{% endif %}</span>
                </label>
                {% if trash_form.non_field_errors %}
                    <div class="form-error form-error--inline">{{ trash_form.non_field_errors.0 }}</div>
                {% endif %}
            </div>
            <div class="trash-list" data-trash-list>
                {% for message_item in deleted_messages %}
                    <label class="trash-item">
                        <input type="checkbox"
                               name="selected"
                               value="{{ message_item.id }}"
                               class="trash-item__checkbox"
                               data-trash-row>
                        <span class="trash-item__content">
                            <span class="trash-item__meta">#{{ message_item.id }} · {{ message_item.email }}</span>
                            <span class="trash-item__preview">{{ message_item.message|truncatechars:120 }}</span>
                        </span>
                        <span class="trash-item__date">{{ message_item.created_at|date:'Y-m-d H:i' }}</span>
                    </label>
                {% empty %}
                    <p class="trash-empty">{% if lang == 'pl' %}Kosz jest pusty.{% else %}Trash is empty.{% endif %}</p>
                {% endfor %}
            </div>
            <div class="modal__actions">
                <button type="submit"
                        class="button button--success"
                        data-trash-action
                        data-trash-action-value="restore"
                        data-requires-selection="true"
                        {% if not deleted_messages %}disabled{% endif %}>
                    {% if lang == 'pl' %}Przywróć zaznaczone{% else %}Restore selected{% endif %}
                </button>
                <button type="submit"
                        class="button button--danger"
                        data-trash-action
                        data-trash-action-value="delete"
                        data-requires-selection="true"
                        {% if not deleted_messages %}disabled{% endif %}>
                    {% if lang == 'pl' %}Usuń zaznaczone{% else %}Delete selected{% endif %}
                </button>
                <button type="submit"
                        class="button button--outline"
                        data-trash-action
                        data-trash-action-value="empty"
                        data-requires-selection="false"
                        {% if not deleted_messages %}disabled{% endif %}>
                    {% if lang == 'pl' %}Opróżnij kosz{% else %}Empty trash{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
<div class="modal{% if download_form.errors %} is-visible{% endif %}"
     data-download-modal
     data-language="{{ lang }}"
     aria-hidden="{% if download_form.errors %}false{% else %}true{% endif %}">
    <div class="modal__backdrop" data-download-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="download-title">
        <button type="button" class="modal__close" data-download-close aria-label="{% if lang == 'pl' %}Zamknij eksport{% else %}Close export{% endif %}">×</button>
        <h2 class="modal__title" id="download-title">{% if lang == 'pl' %}Eksportuj zgłoszenia{% else %}Export requests{% endif %}</h2>
        <form method="post" class="modal__form" data-download-form>
            {% csrf_token %}
            {{ download_form.form_name }}
            <input type="hidden" name="page" value="{{ current_page }}">
            <input type="hidden" name="sort_by" value="{{ current_sort }}">
            <input type="hidden" name="company" value="{{ current_company }}">
            <div class="download-summary" data-download-summary>
                <article class="download-summary__card">
                    <h3 class="download-summary__title">{% if lang == 'pl' %}Wybrane zgłoszenia{% else %}Selected requests{% endif %}</h3>
                    <p class="download-summary__value">
                        <span data-download-requests-count>0</span>
                        <span class="download-summary__total">/
                            <span data-download-requests-total>{{ messages_page|length }}</span>
                        </span>
                    </p>
                    <p class="download-summary__hint"
                       data-download-requests-hint
                       data-empty="{% if lang == 'pl' %}Zaznacz zgłoszenia na liście przed eksportem.{% else %}Select requests in the table before exporting.{% endif %}"
                       data-selected="{% if lang == 'pl' %}Zaznaczone zgłoszenia: {count}.{% else %}Requests selected: {count}.{% endif %}">
                        {% if lang == 'pl' %}Zaznacz zgłoszenia na liście przed eksportem.{% else %}Select requests in the table before exporting.{% endif %}
                    </p>
                </article>
                <article class="download-summary__card">
                    <h3 class="download-summary__title">{% if lang == 'pl' %}Wybrane pola{% else %}Selected fields{% endif %}</h3>
                    <p class="download-summary__value">
                        <span data-download-fields-count>0</span>
                        <span class="download-summary__total">/ {{ download_fields_total|default:0 }}</span>
                    </p>
                    <p class="download-summary__hint"
                       data-download-fields-hint
                       data-empty="{% if lang == 'pl' %}Wybierz pola, które mają znaleźć się w raporcie.{% else %}Choose the fields that should appear in the report.{% endif %}"
                       data-partial="{% if lang == 'pl' %}Wybrano {count} z {total} pól.{% else %}Selected {count} of {total} fields.{% endif %}"
                       data-all="{% if lang == 'pl' %}Wszystkie pola zostaną dołączone do raportu.{% else %}All fields will be included in the report.{% endif %}">
                        {% if lang == 'pl' %}Wybierz pola, które mają znaleźć się w raporcie.{% else %}Choose the fields that should appear in the report.{% endif %}
                    </p>
                    <div class="download-summary__chips"
                         data-download-fields-preview
                         data-empty="{% if lang == 'pl' %}Pola pojawią się tutaj po zaznaczeniu.{% else %}Selected fields will appear here.{% endif %}"
                         data-max="5"></div>
                </article>
            </div>
            {% if download_form.non_field_errors %}
                <div class="form-error">{{ download_form.non_field_errors.0 }}</div>
            {% endif %}
            {% if download_form.messages.errors %}
                <div class="form-error">{{ download_form.messages.errors.0 }}</div>
            {% endif %}
            <div data-download-selected>
                {{ download_form.messages }}
            </div>
            <div class="download-grid">
                <div class="download-column">
                    <h3 class="download-heading">{% if lang == 'pl' %}Wybierz pola{% else %}Choose fields{% endif %}</h3>
                    {% if download_form.fields.errors %}
                        <div class="form-error">{{ download_form.fields.errors.0 }}</div>
                    {% endif %}
                    <div class="download-options" data-download-fields>
                        {% for checkbox in download_form.fields %}
                            {{ checkbox }}
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="modal__actions">
                <button type="submit" class="button button--primary" data-download-submit {% if not download_has_choices %}disabled{% endif %}>
                    {% if lang == 'pl' %}Pobierz PDF{% else %}Download PDF{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
<div class="modal" data-request-modal
     aria-hidden="true"
     data-status-map="{{ status_meta_json|escapejs }}"
     data-detail-template="{% url 'contact:message_detail' 0 %}"
     data-update-template="{% url 'contact:update_message' 0 %}"
     data-success-message="{{ request_update_success_message|escape }}"
     data-detail-error="{{ request_detail_error_message|escape }}"
     data-update-error="{{ request_update_error_message|escape }}"
     data-language="{{ lang }}">
    <div class="modal__backdrop" data-request-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="request-modal-title">
        <button type="button" class="modal__close" data-request-close aria-label="{% if lang == 'pl' %}Zamknij podgląd{% else %}Close preview{% endif %}">×</button>
        <h2 class="modal__title" id="request-modal-title" data-request-title>{% if lang == 'pl' %}Szczegóły zgłoszenia{% else %}Request details{% endif %}</h2>
        <p class="modal__subtitle" data-request-created></p>
        <form method="post" class="modal__form" data-request-form>
            {% csrf_token %}
            <div class="request-modal__grid">
                <label class="request-modal__field">
                    <span class="form-label">{% if lang == 'pl' %}Imię{% else %}First name{% endif %}</span>
                    <input type="text" name="first_name" class="form-input" required>
                </label>
                <label class="request-modal__field">
                    <span class="form-label">{% if lang == 'pl' %}Nazwisko{% else %}Last name{% endif %}</span>
                    <input type="text" name="last_name" class="form-input" required>
                </label>
                <label class="request-modal__field">
                    <span class="form-label">{% if lang == 'pl' %}Telefon{% else %}Phone{% endif %}</span>
                    <input type="text" name="phone" class="form-input" required>
                </label>
                <label class="request-modal__field">
                    <span class="form-label">E-mail</span>
                    <input type="email" name="email" class="form-input" required>
                </label>
                <label class="request-modal__field">
                    <span class="form-label">{% if lang == 'pl' %}Firma{% else %}Company{% endif %}</span>
                    <select name="company" class="form-input" required>
                        {% for option in company_options %}
                            <option value="{{ option.value }}">{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="request-modal__field">
                    <span class="form-label">{% if lang == 'pl' %}Status{% else %}Status{% endif %}</span>
                    <select name="status" class="form-input" required>
                        {% for option in status_options %}
                            <option value="{{ option.value }}">{{ option.label }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="request-modal__field request-modal__field--full">
                    <span class="form-label">{% if lang == 'pl' %}Treść wiadomości{% else %}Message{% endif %}</span>
                    <textarea name="message" rows="6" class="form-input" required></textarea>
                </label>
            </div>
            <div class="form-error" data-request-errors hidden></div>
            <div class="form-success" data-request-feedback hidden></div>
            <div class="modal__actions">
                <button type="button" class="button button--ghost" data-request-close>
                    {% if lang == 'pl' %}Zamknij{% else %}Close{% endif %}
                </button>
                <button type="submit" class="button button--primary" data-request-save>
                    {% if lang == 'pl' %}Zapisz zmiany{% else %}Save changes{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
<header class="topbar">
    <div class="topbar-branding">
        <div class="site-branding">
            <img src="{% static 'img/zet3.avif' %}" alt="ZETOM Katowice" class="site-logo">
            <div>
                <h1 class="site-title">ZETOM Katowice</h1>
                <p class="site-subtitle">{% if lang == 'pl' %}Badania • Certyfikacja • Kontrola techniczna{% else %}Testing • Certification • Technical inspections{% endif %}</p>
            </div>
        </div>
        <p class="topbar-context">{% if lang == 'pl' %}Panel administracyjny · Zarządzaj wiadomościami od klientów{% else %}Admin panel · Manage customer enquiries{% endif %}</p>
    </div>
    <nav class="topbar-nav">
        <a class="nav-link" href="{% url 'contact:index' %}?lang={{ lang }}">{% if lang == 'pl' %}Strona główna{% else %}Website{% endif %}</a>
        <a class="nav-link" href="?lang=pl">PL</a>
        <a class="nav-link" href="?lang=en">EN</a>
        <form method="post" action="{% url 'contact:logout' %}?lang={{ lang }}">
            {% csrf_token %}
            <button type="submit" class="nav-button">{% if lang == 'pl' %}Wyloguj{% else %}Log out{% endif %}</button>
        </form>
    </nav>
</header>

<main class="main">
    {% if messages %}
        <div class="alerts">
            {% for msg in messages %}
                {% with tags=msg.tags %}
                    <div class="alert {% if 'success' in tags %}alert-success{% elif 'error' in tags or 'warning' in tags %}alert-error{% else %}alert-success{% endif %}">
                        {{ msg }}
                    </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% endif %}

    <section class="panel">
        <h2>{% if lang == 'pl' %}Zgłoszenia kontaktowe{% else %}Contact messages{% endif %}</h2>
        <form method="get" class="panel-filters">
            {% if lang %}
                <input type="hidden" name="lang" value="{{ lang }}">
            {% endif %}
            <div class="panel-filters__field">
                <label for="{{ filter_form.sort_by.id_for_label }}" class="form-label">{% if lang == 'pl' %}Sortuj{% else %}Sort{% endif %}</label>
                {{ filter_form.sort_by }}
            </div>
            <div class="panel-filters__field">
                <label for="{{ filter_form.company.id_for_label }}" class="form-label">{% if lang == 'pl' %}Departament{% else %}Department{% endif %}</label>
                {{ filter_form.company }}
            </div>
            <button type="submit" class="button button--primary button--compact">{% if lang == 'pl' %}Zastosuj{% else %}Apply{% endif %}</button>
        </form>
        <form method="post"
              class="panel-form"
              data-bulk-form
              data-empty-selection="{% if lang == 'pl' %}Wybierz co najmniej jedną wiadomość.{% else %}Select at least one message.{% endif %}">
            {% csrf_token %}
            <input type="hidden" name="form_name" value="bulk">
            <input type="hidden" name="page" value="{{ current_page }}">
            <input type="hidden" name="sort_by" value="{{ current_sort }}">
            <input type="hidden" name="company" value="{{ current_company }}">
            <div class="panel-form-row">
                <div class="panel-form-field">
                    <label for="{{ action_form.action.id_for_label }}" class="form-label">{% if lang == 'pl' %}Akcja{% else %}Action{% endif %}</label>
                    {{ action_form.action }}
                    {% if action_form.action.errors %}<div class="form-error">{{ action_form.action.errors.0 }}</div>{% endif %}
                </div>
                <div class="panel-form-actions">
                    <button type="submit" class="button button--primary button--compact" data-bulk-submit>
                        {% if lang == 'pl' %}Wykonaj{% else %}Apply{% endif %}
                    </button>
                    <button type="button"
                            class="button button--ghost button--compact button--download"
                            data-download-open
                            data-download-available="{{ download_has_choices|yesno:'true,false' }}"
                            {% if not download_has_choices or not selected_download_ids %}disabled{% endif %}>
                        {% if lang == 'pl' %}Pobierz{% else %}Download{% endif %}
                    </button>
                    <button type="button" class="button button--ghost button--compact button--trash" data-trash-open>
                        {% if lang == 'pl' %}Kosz{% else %}Trash{% endif %}
                    </button>
                </div>
            </div>
            {% if action_form.selected.errors %}
                <div class="form-error">{{ action_form.selected.errors.0 }}</div>
            {% endif %}

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                    <tr>
                        <th><input type="checkbox" class="table-checkbox" data-select-all aria-label="{% if lang == 'pl' %}Zaznacz wszystkie{% else %}Select all{% endif %}"></th>
                        <th>ID</th>
                        <th>{% if lang == 'pl' %}Data{% else %}Date{% endif %}</th>
                        <th>{% if lang == 'pl' %}Klient{% else %}Customer{% endif %}</th>
                        <th>{% if lang == 'pl' %}Telefon{% else %}Phone{% endif %}</th>
                        <th>E-mail</th>
                        <th>{% if lang == 'pl' %}Firma{% else %}Company{% endif %}</th>
                        <th>{% if lang == 'pl' %}Treść{% else %}Message{% endif %}</th>
                        <th>{% if lang == 'pl' %}Status{% else %}Status{% endif %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for message_item in messages_page %}
                        <tr class="table-row" data-request-row data-request-id="{{ message_item.id }}" tabindex="0">
                            <td>
                                {% with message_id=message_item.id|stringformat:'s' %}
                                <input type="checkbox"
                                       name="selected"
                                       value="{{ message_item.id }}"
                                       class="table-checkbox"
                                       data-row-checkbox
                                       {% if message_id in selected_download_ids %}checked{% endif %}
                                       aria-label="{% if lang == 'pl' %}Zaznacz wiadomość o ID {{ message_item.id }}{% else %}Select message with ID {{ message_item.id }}{% endif %}">
                                {% endwith %}
                            </td>
                            <td data-cell="id">#{{ message_item.id }}</td>
                            <td data-cell="created">{{ message_item.created_at|date:'Y-m-d H:i' }}</td>
                            <td data-cell="customer">{{ message_item.first_name }} {{ message_item.last_name }}</td>
                            <td data-cell="phone"><span class="table-phone" data-cell-phone>{{ message_item.phone }}</span></td>
                            <td data-cell="email">
                                <a href="https://mail.google.com/mail/?view=cm&amp;fs=1&amp;to={{ message_item.email|urlencode }}"
                                   class="table-email"
                                   data-cell-email
                                   target="_blank"
                                   rel="noopener noreferrer">{{ message_item.email }}</a>
                            </td>
                            <td data-cell="company">{{ message_item.company }}</td>
                            <td data-cell="message">{{ message_item.message|linebreaksbr }}</td>
                            <td data-cell="status">
                                {% if message_item.status == message_item.STATUS_NEW %}
                                    <span class="badge badge--success" data-status-badge>{% if lang == 'pl' %}Nowe{% else %}New{% endif %}</span>
                                {% elif message_item.status == message_item.STATUS_IN_PROGRESS %}
                                    <span class="badge badge--warning" data-status-badge>{% if lang == 'pl' %}W trakcie{% else %}In progress{% endif %}</span>
                                {% else %}
                                    <span class="badge badge--info" data-status-badge>{% if lang == 'pl' %}Gotowe{% else %}Ready{% endif %}</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="9" class="empty-state">{% if lang == 'pl' %}Brak wiadomości.{% else %}No messages yet.{% endif %}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

        </form>
    </section>

    {% if paginator.num_pages > 1 %}
        <nav class="pagination" aria-label="{% if lang == 'pl' %}Paginacja wiadomości{% else %}Message pagination{% endif %}">
            <div class="pagination__buttons">
                {% if messages_page.has_previous %}
                    <a class="pagination__button" href="?page={{ messages_page.previous_page_number }}{% if lang %}&amp;lang={{ lang }}{% endif %}{% if current_sort %}&amp;sort_by={{ current_sort }}{% endif %}{% if current_company %}&amp;company={{ current_company }}{% endif %}">
                        ‹ {% if lang == 'pl' %}Poprzednia{% else %}Previous{% endif %}
                    </a>
                {% else %}
                    <span class="pagination__button pagination__button--disabled">
                        ‹ {% if lang == 'pl' %}Poprzednia{% else %}Previous{% endif %}
                    </span>
                {% endif %}

                <ul class="pagination__list">
                    {% for page_number in page_range %}
                        {% if page_number == '…' %}
                            <li class="pagination__ellipsis">…</li>
                        {% else %}
                            {% if page_number == messages_page.number %}
                                <li><span class="pagination__page pagination__page--active">{{ page_number }}</span></li>
                            {% else %}
                                <li>
                                    <a class="pagination__page" href="?page={{ page_number }}{% if lang %}&amp;lang={{ lang }}{% endif %}{% if current_sort %}&amp;sort_by={{ current_sort }}{% endif %}{% if current_company %}&amp;company={{ current_company }}{% endif %}">{{ page_number }}</a>
                                </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </ul>

                {% if messages_page.has_next %}
                    <a class="pagination__button" href="?page={{ messages_page.next_page_number }}{% if lang %}&amp;lang={{ lang }}{% endif %}{% if current_sort %}&amp;sort_by={{ current_sort }}{% endif %}{% if current_company %}&amp;company={{ current_company }}{% endif %}">
                        {% if lang == 'pl' %}Następna{% else %}Next{% endif %} ›
                    </a>
                {% else %}
                    <span class="pagination__button pagination__button--disabled">
                        {% if lang == 'pl' %}Następna{% else %}Next{% endif %} ›
                    </span>
                {% endif %}
            </div>

            <form method="get" class="pagination__goto" aria-label="{% if lang == 'pl' %}Przejdź do strony{% else %}Go to page{% endif %}">
            {% if lang %}
                <input type="hidden" name="lang" value="{{ lang }}">
            {% endif %}
            {% if current_sort %}
                <input type="hidden" name="sort_by" value="{{ current_sort }}">
            {% endif %}
            {% if current_company %}
                <input type="hidden" name="company" value="{{ current_company }}">
            {% endif %}
            <label class="pagination__label" for="pagination-page">
                {% if lang == 'pl' %}Idź do{% else %}Go to{% endif %}
            </label>
            <input
                    type="number"
                    id="pagination-page"
                    name="page"
                    min="1"
                    max="{{ paginator.num_pages }}"
                    value="{{ messages_page.number }}"
                    class="pagination__input"
                >
                <button type="submit" class="pagination__submit button button--ghost button--compact">
                    {% if lang == 'pl' %}Przejdź{% else %}Go{% endif %}
                </button>
            </form>
        </nav>
    {% endif %}

    <section class="email-card">
        <h2>{% if lang == 'pl' %}Wyślij wiadomość do klienta{% else %}Send an email to a customer{% endif %}</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="send_email" value="1">
            <input type="hidden" name="sort_by" value="{{ current_sort }}">
            <input type="hidden" name="company" value="{{ current_company }}">
            {% if email_form.non_field_errors %}
                <div class="form-error">{{ email_form.non_field_errors.0 }}</div>
            {% endif %}
            <div class="email-grid">
                <div>
                    <label for="{{ email_form.to_email.id_for_label }}" class="form-label">E-mail</label>
                    {{ email_form.to_email }}
                    {% if email_form.to_email.errors %}<div class="form-error">{{ email_form.to_email.errors.0 }}</div>{% endif %}
                </div>
                <div>
                    <label for="{{ email_form.subject.id_for_label }}" class="form-label">{% if lang == 'pl' %}Temat{% else %}Subject{% endif %}</label>
                    {{ email_form.subject }}
                    {% if email_form.subject.errors %}<div class="form-error">{{ email_form.subject.errors.0 }}</div>{% endif %}
                </div>
                <div style="grid-column: 1 / -1;">
                    <label for="{{ email_form.body.id_for_label }}" class="form-label">{% if lang == 'pl' %}Treść{% else %}Message{% endif %}</label>
                    {{ email_form.body }}
                    {% if email_form.body.errors %}<div class="form-error">{{ email_form.body.errors.0 }}</div>{% endif %}
                </div>
                <div>
                    <label for="{{ email_form.attachment.id_for_label }}" class="form-label">{% if lang == 'pl' %}Załącznik (opcjonalnie){% else %}Attachment (optional){% endif %}</label>
                    {{ email_form.attachment }}
                    {% if email_form.attachment.errors %}<div class="form-error">{{ email_form.attachment.errors.0 }}</div>{% endif %}
                </div>
            </div>
            <button type="submit" class="form-submit">{% if lang == 'pl' %}Wyślij e-mail{% else %}Send email{% endif %}</button>
        </form>
    </section>
</main>
</body>
</html>
